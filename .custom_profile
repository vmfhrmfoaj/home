#!/bin/zsh

function setEnv () {
  # locale
  export LANG=en_US.UTF-8
  export LC_ALL=en_US.UTF-8

  # PATH
  if [ 0 = $(echo ${PATH} | grep -c '/sbin') ]; then
    export PATH="/sbin:/usr/sbin:${PATH}"
  fi
  if [ -d "${HOME}/.bin" ] && [ 0 = $(echo ${PATH} | grep -c "${HOME}/.bin") ]; then
    export PATH="${HOME}/.bin:${PATH}"
  fi

  # Cask
  if [ -d "${HOME}/.cask/bin" ]; then
    export PATH="${HOME}/.cask/bin:${PATH}"
  fi

  # Oh My Zsh
  if [ ! -z $ZSH ]; then
    if [ ! -z "$(echo $plugins | grep 'vi-mode')" ]; then
      # NOTE
      #  You should change 'backspace key generates' option to control-h on the Gnome terminal.
      bindkey -M viins '^?' backward-kill-word
      bindkey -M viins '^b' backward-char
      bindkey -M viins '^f' forward-char
      bindkey -M viins '^d' delete-char
    fi
    local NEWLINE=$'\n'
    local PS1_PREFIX='%{$fg[magenta]%}(%n@%M)%{$reset_color%}'
    export PS1="${PS1_PREFIX}${NEWLINE}${PS1}"
  fi

  # Heroku
  local HEROKU="${HOME}/.local/heroku"
  if [ -d "${HEROKU}/bin/" ] && [ 0 = $(echo ${PATH} | grep -c "${HEROKU}/bin") ]; then
    export PATH="${HEROKU}/bin/:${PATH}"
  fi

  #
  # Docker container for development environment
  #

  # PATH
  local dev_tool_dir="${HOME}/Desktop/Tools/my-dev-env"
  if [ -d ${dev_tool_dir} ] && [ 0 = $(echo ${PATH} | grep -c "${dev_tool_dir}/bin") ]; then
    PATH="${dev_tool_dir}/bin:${PATH}"
  fi

  # Android
  if [ ! -z ${ANDROID_HOME} ] && [ -d ${ANDROID_HOME} ] && [ 0 = $(echo ${PATH} | grep -c "${ANDROID_HOME}") ]; then
    export PATH="${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools:${PATH}"
  fi

  # Clojure
  if [ ! -z ${GRAALVM_ROOT} ] && [ -d ${GRAALVM_ROOT} ] && [ 0 = $(echo ${PATH} | grep -c "${GRAALVM_ROOT}/bin") ]; then
    export PATH="${PATH}:${GRAALVM_ROOT}/bin"
  fi

  # Perl
  if [ ! -z ${PERLBREW_ROOT} ]; then
    if [ -f "${PERLBREW_ROOT}/etc/bashrc" ]; then
      source "${PERLBREW_ROOT}/etc/bashrc"
    fi
  fi
}
setEnv

CURSOR_BOX='\e[2 q'
CURSOR_UNDERBAR='\e[4 q'
CURSOR_LINE='\e[6 q'

function zle-keymap-select () {
  if [ "$TERM" = "xterm-256color" ]; then
    if [ "$KEYMAP" = vicmd ]; then
      # the command mode for vi
      echo -ne $CURSOR_BOX
    else
      # the insert mode for vi
      echo -ne $CURSOR_UNDERBAR
    fi
  fi
  # for Oh My Zsh
  zle reset-prompt
  zle -R
}
zle -N zle-keymap-select

export DISABLE_AUTO_TITLE="true"
function precmd {
  local TABNAME="%n@%M: %~"
  title $TABNAME $TABNAME
}

function preexec() {
  local TABNAME="%n@%M"
  local TABNAME="$TABNAME: %~: ${2:gs/%/%%}"
  title $TABNAME $TABNAME
  echo -ne $CURSOR_UNDERBAR
}
preexec

which numlockx 2>&1 > /dev/null
if [ $? -eq 0 ]; then
  numlockx on
fi
